//‡∏î‡∏∂‡∏á express ‡∏°‡∏≤‡πÉ‡∏ä‡πâ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á web api
//‡πÉ‡∏ô node.js ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô api ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏ä‡πà‡∏ô get/post/put/delete
import express from "express";

//‡∏î‡∏∂‡∏á pool ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå db.mjs ‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö postgreSQL 
//‡πÑ‡∏ß‡πâ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö database ‡πÄ‡∏ä‡πà‡∏ô pool.query()
import pool from "./utils/db.mjs";

//‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ app = ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô express(); ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á server
const app = express();

//‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡πà‡∏≤ port = 4001 ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤ server ‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏ó‡∏µ‡πà port 4001
const port = 4001;

//‡∏ó‡∏≥‡πÉ‡∏´‡πâ express ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏ó‡∏µ‡πà client ‡∏™‡πà‡∏á‡∏°‡∏≤
//‡∏ó‡∏∏‡∏Å API ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô JSON ‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏î
app.use(express.json());


//‡∏™‡∏£‡πâ‡∏≤‡∏á api .http method = post ("endpoint = assignment") , async = ‡∏£‡∏≠ 
app.post("/assignments", async (req, res) => {
// 1) Access ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Body ‡∏à‡∏≤‡∏Å Request ‡∏î‡πâ‡∏ß‡∏¢ req.body
  //‡πÉ‡∏ä‡πâ ‡∏î‡∏±‡∏Å error ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏á‡∏à‡∏∞‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÑ‡∏õ catch
  try {

    //‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà client ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏≤‡∏á req.body //req.body ‡∏Ñ‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà client ‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏à‡∏≤‡∏Å Postman) 
    //client ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ server ‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à  *‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤ const ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô {} 
    const { user_id, title, content, category, length, status } = req.body;

    
    //‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ 
    if (!user_id || !title || !content || !category || length === undefined || !status) {

      //‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 400 ‡∏ã‡∏∂‡πà‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
      //‡πÅ‡∏•‡∏∞ .json ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡πà‡∏≤ ({message ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏≠‡∏á client})
      return res.status(400).json({
       // 
        message:
          "Server could not create assignment because there are missing data from client",
      });
    }


   //‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô database ‡πÇ‡∏î‡∏¢ function new Date();
    const created_at = new Date();
    const updated_at = new Date();

// 2) ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Query ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏û‡∏™‡∏ï‡πå ‡∏î‡πâ‡∏ß‡∏¢ Connection Pool
  //‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SQL ‡πÑ‡∏õ‡∏ó‡∏µ‡πà postgreSQL ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞ insert ‡πÄ‡∏™‡∏£‡πá‡∏à
    await pool.query(

      //‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞ insert into ‡πÄ‡∏Ç‡πâ‡∏≤ table assignments ‡∏ï‡∏≤‡∏° column ‡πÉ‡∏ô ()
      //‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 57 ‡πÉ‡∏ä‡πâ placeholder ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô SQL injection 
      //placeholder = ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ú‡πà‡∏≤‡∏ô array ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
      `INSERT INTO assignments
      ( user_id,title, content, category, length, status, created_at, updated_at)
      VALUES ($1,$2,$3,$4,$5,$6,$7,$8)`,
      [ user_id, title, content, category, length, status, created_at, updated_at]
    );

    // 3) Return ‡∏ï‡∏±‡∏ß Response ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏≤ Client ‡∏ß‡πà‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    //‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 201 ‡∏ã‡∏∂‡πà‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö
    //‡πÅ‡∏•‡∏∞ .json ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡πà‡∏≤ ({message ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏≠‡∏á client})
    return res.status(201).json({
      message: "Created assignment successfully",
    });

  //‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏ô try ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏µ‡πà catch
  } catch (error) {
  //‡∏ñ‡πâ‡∏≤  error ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å SQL === "23502" = ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ 
    if (error.code === "23502") {
    //‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 400 ‡∏ã‡∏∂‡πà‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
    //‡πÅ‡∏•‡∏∞ .json ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡πà‡∏≤ ({message ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏≠‡∏á client})
      return res.status(400).json({
        message:
          "Server could not create assignment because there are missing data from client",
      });
    }
//‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ //‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 500  ‡∏ã‡∏∂‡πà‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    //‡πÅ‡∏•‡∏∞ .json ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡πà‡∏≤ ({message ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏≠‡∏á client})
    return res.status(500).json({
      message: "Server could not create assignment because database connection",
    });
  }
});

//‡πÑ‡∏ß‡πâ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏±‡πâ‡∏¢ 
app.get("/test", (req, res) => {
  //‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏Ñ‡πà‡∏≤ "Server API is working üöÄ"
  return res.json("Server API is working üöÄ");
});


//‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏≥server ‡πÄ‡∏£‡∏∑‡πà‡∏¥‡∏° ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‡∏ó‡∏µ‡πà port 4000
app.listen(port, () => {
  //‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ô server ‡∏≠‡∏¢‡∏π‡πà
  console.log(`Server is running at ${port}`);
});
